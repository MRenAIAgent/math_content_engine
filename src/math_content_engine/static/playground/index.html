<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Content Playground</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
    <!-- highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/python.min.js"></script>
</head>
<body>
    <!-- ============================================================ -->
    <!-- HEADER                                                        -->
    <!-- ============================================================ -->
    <header class="header">
        <div class="header-title">
            <span>&#x1F9EA;</span> Math Content Playground
        </div>
        <div class="header-config">
            <span class="badge" id="config-provider">loading...</span>
            <span class="badge" id="config-model"></span>
        </div>
    </header>

    <!-- ============================================================ -->
    <!-- MAIN CONTENT (single-page, no sidebar)                        -->
    <!-- ============================================================ -->
    <main class="main-content">

        <!-- ---- LLM Settings Bar ---- -->
        <div class="llm-settings-bar">
            <div class="llm-settings-toggle" onclick="toggleLLMSettings()">
                <span class="settings-icon">&#x2699;</span>
                <span>LLM Settings</span>
                <span class="llm-settings-summary" id="llm-settings-summary"></span>
                <span class="chevron" id="llm-settings-chevron">&#x25B6;</span>
            </div>
            <div class="llm-settings-panel" id="llm-settings-panel">
                <div class="form-row">
                    <div class="form-group">
                        <label>Temperature</label>
                        <div class="range-with-value">
                            <input type="range" id="llm-temperature" min="0" max="1" step="0.05" value="0.7"
                                   oninput="onTemperatureChange()" />
                            <span id="llm-temperature-value" class="range-value">0.70</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Max Tokens</label>
                        <select id="llm-max-tokens" onchange="onMaxTokensChange()">
                            <option value="2048">2,048</option>
                            <option value="4096" selected>4,096</option>
                            <option value="8192">8,192</option>
                            <option value="16384">16,384</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <span class="badge readonly-badge" id="llm-model-display">loading...</span>
                    </div>
                    <div class="form-group">
                        <label>Provider</label>
                        <span class="badge readonly-badge" id="llm-provider-display">loading...</span>
                    </div>
                </div>
                <div class="settings-hint">
                    Temperature controls creativity (0 = deterministic, 1 = creative).
                    Max tokens caps the response length. Model/provider set via env vars.
                </div>
            </div>
        </div>

        <!-- ---- Student & Engagement Settings Bar ---- -->
        <div class="llm-settings-bar">
            <div class="llm-settings-toggle" onclick="toggleStudentSettings()">
                <span class="settings-icon">&#x1F393;</span>
                <span>Student &amp; Engagement</span>
                <span class="llm-settings-summary" id="student-settings-summary"></span>
                <span class="chevron" id="student-settings-chevron">&#x25B6;</span>
            </div>
            <div class="llm-settings-panel" id="student-settings-panel">
                <div class="form-row">
                    <div class="form-group" style="flex: 1">
                        <label>Interests</label>
                        <input type="text" id="global-interest" placeholder="e.g. basketball, music, gaming" oninput="onGlobalInterestChange()" />
                    </div>
                </div>
                <div class="settings-section-label">Student Profile</div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1">
                        <label>Student Name</label>
                        <input type="text" id="global-student-name" placeholder="e.g. Jordan" oninput="onGlobalSettingChange()" />
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label>Preferred Address</label>
                        <input type="text" id="global-preferred-address" placeholder="e.g. J, champ, bro" oninput="onGlobalSettingChange()" />
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label>Grade Level</label>
                        <input type="text" id="global-grade-level" placeholder="e.g. 8th grade" oninput="onGlobalSettingChange()" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1">
                        <label>City</label>
                        <input type="text" id="global-city" placeholder="e.g. San Francisco" oninput="onGlobalSettingChange()" />
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label>State</label>
                        <input type="text" id="global-state" placeholder="e.g. California" oninput="onGlobalSettingChange()" />
                    </div>
                </div>
                <div class="settings-section-label">Engagement Profile</div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1">
                        <label>Favorite Figure</label>
                        <input type="text" id="global-favorite-figure" placeholder="e.g. Stephen Curry, Taylor Swift" oninput="onGlobalSettingChange()" />
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label>Favorite Team</label>
                        <input type="text" id="global-favorite-team" placeholder="e.g. Warriors, Lakers" oninput="onGlobalSettingChange()" />
                    </div>
                </div>
                <div class="settings-hint">
                    These settings apply to all pipeline stages. Interest must match a known profile (e.g. basketball, gaming, music) for personalization to activate.
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PIPELINE SECTION 1: Upload Content                            -->
        <!-- ============================================================ -->
        <div class="pipeline-section" id="section-upload">
            <div class="pipeline-section-toggle" onclick="toggleSection('upload')">
                <span class="chevron expanded" id="chevron-upload">&#x25B6;</span>
                <span class="step-badge">1</span>
                <span class="section-label">Upload Textbook Content</span>
                <span class="section-status empty" id="status-upload"></span>
            </div>
            <div class="pipeline-section-body visible" id="body-upload">
                <div class="form-row">
                    <div class="form-group">
                        <label>Upload File (PDF or Markdown)</label>
                        <input type="file" id="textbook-file-input" accept=".pdf,.md,.txt,.markdown" onchange="onFileUpload()" />
                    </div>
                    <div class="form-group">
                        <label>Or load sample</label>
                        <button class="btn btn-sm" onclick="loadSampleContent()">Load Sample</button>
                    </div>
                </div>

                <div class="progress-bar" id="progress-upload" style="display:none">
                    <div class="spinner"></div>
                    <span id="progress-text-upload">Uploading...</span>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="label">Textbook Content</span>
                        <span id="upload-stats" class="text-muted" style="font-weight:normal"></span>
                    </div>
                    <div class="card-body">
                        <textarea
                            class="prompt-textarea"
                            id="textbook-input"
                            placeholder="Paste your textbook content here, upload a PDF/Markdown file above, or click 'Load Sample'..."
                            style="min-height: 300px"
                            oninput="onTextbookInput()"
                        ></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PIPELINE SECTION 2: Extract Concepts                          -->
        <!-- ============================================================ -->
        <div class="pipeline-section" id="section-extract_concepts">
            <div class="pipeline-section-toggle" onclick="toggleSection('extract_concepts')">
                <span class="chevron" id="chevron-extract_concepts">&#x25B6;</span>
                <span class="step-badge">2</span>
                <span class="section-label">Extract Concepts</span>
                <span class="section-status empty" id="status-extract_concepts"></span>
            </div>
            <div class="pipeline-section-body" id="body-extract_concepts">
                <div class="card">
                    <div class="card-header">
                        <span class="label">System Prompt</span>
                        <button class="btn btn-sm" onclick="resetPrompt('extract_concepts', 'system')">Reset</button>
                    </div>
                    <div class="card-body">
                        <textarea class="prompt-textarea" id="prompt-extract_concepts-system" placeholder="Auto-loaded when section opens..."></textarea>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="label">User Prompt</span>
                        <button class="btn btn-sm" onclick="resetPrompt('extract_concepts', 'user')">Reset</button>
                    </div>
                    <div class="card-body">
                        <textarea class="prompt-textarea" id="prompt-extract_concepts-user" placeholder="Auto-loaded when section opens..."></textarea>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="previewPrompts('extract_concepts')">Preview Prompts</button>
                    <button class="btn btn-primary" onclick="executeStage('extract_concepts')" id="btn-exec-extract_concepts">
                        Extract Concepts &#x25B6;
                    </button>
                </div>

                <div class="progress-bar" id="progress-extract_concepts">
                    <div class="spinner"></div>
                    <span id="progress-text-extract_concepts">Extracting concepts...</span>
                </div>

                <div class="card" id="output-card-extract_concepts" style="display:none">
                    <div class="card-header">
                        <span class="label">Extracted Concepts</span>
                        <span class="stats-bar" id="stats-extract_concepts"></span>
                    </div>
                    <div class="card-body">
                        <div class="output-panel json-output" id="output-extract_concepts"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PIPELINE SECTION 3: Personalize Content                       -->
        <!-- ============================================================ -->
        <div class="pipeline-section" id="section-personalize">
            <div class="pipeline-section-toggle" onclick="toggleSection('personalize')">
                <span class="chevron" id="chevron-personalize">&#x25B6;</span>
                <span class="step-badge">3</span>
                <span class="section-label">Personalize Content</span>
                <span class="section-status empty" id="status-personalize"></span>
            </div>
            <div class="pipeline-section-body" id="body-personalize">
                <div class="card">
                    <div class="card-header">
                        <span class="label">System Prompt</span>
                        <button class="btn btn-sm" onclick="resetPrompt('personalize', 'system')">Reset</button>
                    </div>
                    <div class="card-body">
                        <textarea class="prompt-textarea small" id="prompt-personalize-system" placeholder="Auto-loaded when section opens..."></textarea>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="label">User Prompt</span>
                        <button class="btn btn-sm" onclick="resetPrompt('personalize', 'user')">Reset</button>
                    </div>
                    <div class="card-body">
                        <textarea class="prompt-textarea" id="prompt-personalize-user" placeholder="Auto-loaded when section opens..."></textarea>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="previewPrompts('personalize')">Preview Prompts</button>
                    <button class="btn btn-primary" onclick="executeStage('personalize')" id="btn-exec-personalize">
                        Personalize &#x25B6;
                    </button>
                </div>

                <div class="progress-bar" id="progress-personalize">
                    <div class="spinner"></div>
                    <span id="progress-text-personalize">Personalizing...</span>
                </div>

                <div class="card" id="output-card-personalize" style="display:none">
                    <div class="card-header">
                        <span class="label">Personalized Content</span>
                        <span class="stats-bar" id="stats-personalize"></span>
                    </div>
                    <div class="card-body">
                        <div class="output-panel markdown-output" id="output-personalize"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PIPELINE SECTION 4: Generate Animations                       -->
        <!-- ============================================================ -->
        <div class="pipeline-section" id="section-generate_animation">
            <div class="pipeline-section-toggle" onclick="toggleSection('generate_animation')">
                <span class="chevron" id="chevron-generate_animation">&#x25B6;</span>
                <span class="step-badge">4</span>
                <span class="section-label">Generate Animations</span>
                <span class="section-status empty" id="status-generate_animation"></span>
            </div>
            <div class="pipeline-section-body" id="body-generate_animation">
                <!-- Concept selector from extracted concepts -->
                <div id="concept-selector-area" style="display:none">
                    <div class="card">
                        <div class="card-header">
                            <span class="label">Select Concepts to Animate</span>
                            <div>
                                <button class="btn btn-sm" onclick="selectAllConcepts(true)">All</button>
                                <button class="btn btn-sm" onclick="selectAllConcepts(false)">None</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="concept-checklist" id="concept-checklist"></div>
                        </div>
                    </div>
                </div>

                <!-- Manual topic entry (fallback when no concepts extracted) -->
                <div id="manual-topic-area">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2">
                            <label>Topic (or auto-filled from concepts)</label>
                            <input type="text" id="anim-topic" placeholder="e.g. Solving Two-Step Linear Equations" />
                        </div>
                        <div class="form-group">
                            <label>Style</label>
                            <select id="anim-style">
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Audience</label>
                            <select id="anim-audience">
                                <option value="high school">High School</option>
                                <option value="middle school">Middle School</option>
                                <option value="college">College</option>
                                <option value="elementary">Elementary</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1">
                            <label>Requirements</label>
                            <input type="text" id="anim-requirements" placeholder="Additional requirements (optional)" />
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="label">System Prompt</span>
                        <button class="btn btn-sm" onclick="resetPrompt('generate_animation', 'system')">Reset</button>
                    </div>
                    <div class="card-body">
                        <textarea class="prompt-textarea" id="prompt-generate_animation-system" placeholder="Auto-loaded when section opens..."></textarea>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="label">User Prompt</span>
                        <button class="btn btn-sm" onclick="resetPrompt('generate_animation', 'user')">Reset</button>
                    </div>
                    <div class="card-body">
                        <textarea class="prompt-textarea" id="prompt-generate_animation-user" placeholder="Auto-loaded when section opens..."></textarea>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="previewPrompts('generate_animation')">Preview Prompts</button>
                    <button class="btn btn-primary" onclick="executeSingleAnimation()" id="btn-exec-generate_animation">
                        Generate Single &#x25B6;
                    </button>
                    <button class="btn btn-primary" onclick="executeBatchAnimations()" id="btn-batch-generate" style="display:none">
                        Generate All Concepts &#x25B6;
                    </button>
                </div>

                <div class="progress-bar" id="progress-generate_animation">
                    <div class="spinner"></div>
                    <span id="progress-text-generate_animation">Generating...</span>
                </div>

                <!-- Single animation output (for manual topic) -->
                <div class="card" id="output-card-generate_animation" style="display:none">
                    <div class="card-header">
                        <span class="label">Generated Manim Code</span>
                        <div>
                            <span class="stats-bar" id="stats-generate_animation" style="display:inline-flex"></span>
                            <button class="btn btn-sm" onclick="copyCode()">Copy</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="output-panel code-output" id="output-generate_animation"></div>
                    </div>
                </div>

                <!-- Batch animation results -->
                <div class="batch-results" id="batch-results"></div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PIPELINE SECTION 5: Render Videos                             -->
        <!-- ============================================================ -->
        <div class="pipeline-section" id="section-render">
            <div class="pipeline-section-toggle" onclick="toggleSection('render')">
                <span class="chevron" id="chevron-render">&#x25B6;</span>
                <span class="step-badge">5</span>
                <span class="section-label">Render Videos</span>
                <span class="section-status empty" id="status-render"></span>
            </div>
            <div class="pipeline-section-body" id="body-render">
                <div class="form-row">
                    <div class="form-group">
                        <label>Quality</label>
                        <select id="render-quality">
                            <option value="l">Low (480p) - fast</option>
                            <option value="m">Medium (720p)</option>
                            <option value="h">High (1080p)</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="label">Manim Code (editable)</span>
                        <span id="render-scene-name" style="font-weight: normal; color: var(--text-muted)"></span>
                    </div>
                    <div class="card-body">
                        <textarea class="prompt-textarea" id="render-code" style="min-height: 300px" placeholder="Generate animation code first (step 4), or paste code here..."></textarea>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="executeRender()" id="btn-exec-render">
                        Render Video &#x25B6;
                    </button>
                    <button class="btn btn-primary" onclick="renderAllBatchResults()" id="btn-batch-render" style="display:none">
                        Render All &#x25B6;
                    </button>
                </div>

                <div class="progress-bar" id="progress-render">
                    <div class="spinner"></div>
                    <span id="progress-text-render">Rendering...</span>
                </div>

                <div id="video-output" style="display:none">
                    <div class="video-container">
                        <video id="rendered-video" controls></video>
                    </div>
                    <div class="stats-bar" id="stats-render"></div>
                </div>

                <!-- Batch render results -->
                <div class="batch-results" id="batch-render-results"></div>
            </div>
        </div>

        <!-- ---- Run History ---- -->
        <div class="history-bar">
            <div class="history-title">Run History</div>
            <div id="history-list">
                <div style="padding: 4px 0; font-size: 13px; color: var(--text-muted);">
                    No runs yet
                </div>
            </div>
        </div>

    </main>

    <!-- Toast container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="app.js"></script>
</body>
</html>
